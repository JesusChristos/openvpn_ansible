---
# tasks file for openvpn




- name: Create USERNAME_DIR                                             #https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
  shell: mkdir $(whoami)
  args:
    chdir: "/etc/openvpn/client/"
    warn: false
  #register: USERNAME

- name: Whoami                                            #https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
  shell: whoami
  register: USERNAME


- name: Build certificate client
  shell: /usr/share/easy-rsa/easyrsa build-client-full $(whoami) nopass && 
          cp -r ~/{{ CERT_ROOT_DIR }}/pki/issued/$(whoami).crt /etc/openvpn/client/$(whoami) &&
          cp -r ~/{{ CERT_ROOT_DIR }}/pki/private/$(whoami).key /etc/openvpn/client/$(whoami)    #https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
  args:
    chdir: "{{ CERT_ROOT_DIR }}"
  register: this

- debug:
    msg: "{{ this }}"


#- name: Build certificate client
#  shell: /usr/share/easy-rsa/easyrsa build-client-full $(whoami) nopass      #https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
#  args:
#    chdir: "{{ CERT_ROOT_DIR }}"


#- name: Create USERNAME_DIR                                             #https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
#  shell: mkdir $(whoami)
#  args:
#    chdir: "/etc/openvpn/client/"
#    warn: false
#  register: USERNAME

#- name: Build certificate client
#  shell: /usr/share/easy-rsa/easyrsa build-client-full $(whoami) nopass      #https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
#  args:
#    chdir: "{{ CERT_ROOT_DIR }}"

#- name: copy pki files
  #copy: 
    #src: "~/certificate_authority/"
    #dest: "~" 
    #remote_src: yes 
    #directory_mode: yes

#- name: Copy username.crt, username.key
#  copy:                                                                       #https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
#    src: "~/{{ CERT_ROOT_DIR }}/{{ item.path }}/{{ item.name }}"
#    dest: "/etc/openvpn/client/{{ USERNAME }}"
#    remote_src: yes
#  loop:
#    - { name: "{{ USERNAME }}.crt", path: "pki/issued"}
    #- { name: "{{ USERNAME }}.key", path: "pki"}